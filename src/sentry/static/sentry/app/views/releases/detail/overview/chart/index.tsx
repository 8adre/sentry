import React from 'react';
import * as ReactRouter from 'react-router';
import {Location} from 'history';

import {GlobalSelection, Organization} from 'app/types';
import {Panel} from 'app/components/panels';
import {Client} from 'app/api';
import EventsChart from 'app/components/charts/eventsChart';
import {t} from 'app/locale';
import {decodeScalar} from 'app/utils/queryString';
import theme from 'app/utils/theme';

import ReleaseChartControls, {YAxis, PERFORMANCE_AXIS} from './releaseChartControls';
import {ReleaseStatsRequestRenderProps} from '../releaseStatsRequest';
import HealthChartContainer from './healthChartContainer';
import {getReleaseEventView} from './utils';

type Props = Omit<ReleaseStatsRequestRenderProps, 'crashFreeTimeBreakdown'> & {
  selection: GlobalSelection;
  yAxis: YAxis;
  onYAxisChange: (yAxis: YAxis) => void;
  router: ReactRouter.InjectedRouter;
  organization: Organization;
  hasHealthData: boolean;
  location: Location;
  api: Client;
  version: string;
  hasDiscover: boolean;
  hasPerformance: boolean;
};

class ReleaseChartContainer extends React.Component<Props> {
  getChartColors(): [string, string] {
    const {yAxis} = this.props;

    switch (yAxis) {
      case YAxis.FAILED_TRANSACTIONS:
      case YAxis.EVENTS:
        return [theme.red300, theme.red100];
      default:
        return [theme.purple300, theme.purple100];
    }
  }

  seriesNameTransformer(name: string): string {
    // The names of these series are generated by the backend.
    // Specifically, the eventView objects from getReleaseEventView
    // in releases/detail/overview/chart/utils.tsx ensures the
    // names of these series using the to_other function.
    switch (name) {
      case 'current':
        return t('This Release');
      case 'others':
        return t('Other Releases');
      default:
        return name;
    }
  }

  renderTransactionsChart() {
    const {location, router, organization, api, yAxis, selection, version} = this.props;
    const {projects, environments, datetime} = selection;
    const {start, end, period, utc} = datetime;
    const eventView = getReleaseEventView(selection, version, yAxis, organization);
    const apiPayload = eventView.getEventsAPIPayload(location);
    const colors = this.getChartColors();

    return (
      <EventsChart
        router={router}
        organization={organization}
        showLegend
        yAxis={eventView.getYAxis()}
        query={apiPayload.query}
        api={api}
        projects={projects}
        environments={environments}
        start={start}
        end={end}
        period={period}
        utc={utc}
        disablePrevious
        disableReleases
        field={eventView.getFields()}
        topEvents={2}
        orderby={decodeScalar(apiPayload.sort)}
        currentSeriesName={t('This Release')}
        // This seems a little strange but is intentional as EventsChart
        // uses the previousSeriesName as the secondary series name
        previousSeriesName={t('Other Releases')}
        seriesNameTransformer={this.seriesNameTransformer}
        disableableSeries={[t('This Release'), t('Other Releases')]}
        colors={colors}
      />
    );
  }

  renderHealthChart() {
    const {loading, errored, reloading, chartData, selection, yAxis, router} = this.props;

    return (
      <HealthChartContainer
        loading={loading}
        errored={errored}
        reloading={reloading}
        chartData={chartData}
        selection={selection}
        yAxis={yAxis}
        router={router}
      />
    );
  }

  render() {
    const {
      yAxis,
      hasDiscover,
      hasHealthData,
      hasPerformance,
      chartSummary,
      onYAxisChange,
      organization,
    } = this.props;

    let chart: React.ReactNode = null;
    if ((hasDiscover || hasPerformance) && PERFORMANCE_AXIS.includes(yAxis)) {
      chart = this.renderTransactionsChart();
    } else {
      chart = this.renderHealthChart();
    }

    return (
      <Panel>
        {chart}
        <ReleaseChartControls
          summary={chartSummary}
          yAxis={yAxis}
          onYAxisChange={onYAxisChange}
          organization={organization}
          hasDiscover={hasDiscover}
          hasHealthData={hasHealthData}
          hasPerformance={hasPerformance}
        />
      </Panel>
    );
  }
}

export default ReleaseChartContainer;
